---
title: "Migrate SSO without IdP reconfiguration for customers"
description: "Learn how to coexist with external SSO providers while gradually migrating to Scalekit's SSO solution"
sidebar:
  label: 'SSO migration strategy'
  hidden: true
topic: 'sso'
tableOfContents: true
head:
  - tag: style
    content: |
      .sl-markdown-content h2 {
        font-size: var(--sl-text-xl);
      }
      .sl-markdown-content h3 {
        font-size: var(--sl-text-lg);
      }
---

import { Steps, Aside, Badge } from '@astrojs/starlight/components'


Single Sign-On capability of your application allows users in your customer organizations to access your application using their existing credentials. External SSO providers such as Auth0 and WorkOS manage SSO connections with your customer's identity providers.

In this guide, you will migrate SSO connections to Scalekit without requiring customers to reconfigure their identity providers.

### Prerequisites

1. You control DNS for your auth domain, and its CNAME points to your external SSO provider.
2. Scalekit is set up — you have <a href="https://app.scalekit.com" target="_blank" rel="noopener">signed up</a> and installed the <a href="https://docs.scalekit.com/fsa/quickstart/#install-the-scalekit-sdk" target="_blank" rel="noopener">Scalekit SDK</a>.

## Current setup with external SSO provider

### IdP configurations

Your customers have configured their identity provider with necessary settings such as **SP Entity ID** and **ACS URL**. These should start with a domain that you own such as `auth.yourapp.com/rest/of/the/path` where CNAME is correctly configured with your external SSO provider.

### SSO integrations

Your application integrates with an external SSO provider to manage SSO connections with your customers' identity providers. This is the ideal flow:

1. Users come to your application and enter their email address to log in using SSO.
2. Your app uses connection selectors such as email domain, organization ID, or connection ID to identify the user's identity provider.
3. Your app redirects the user to the identity provider and verifies their identity to continue login.
4. Your app receives an authorization code from the external SSO provider and exchanges it for user profile information to complete login.

## Approach to migrate SSO connections

Customers have already configured their identity provider with necessary service provider settings over the domain you own and the CNAME is correctly configured with your external SSO provider. An ideal experience should not require reconfiguration or cause disruption.

1. Set up an **SSO proxy** service that sits between your application and the external SSO provider. The proxy is responsible for handling authentication requests between Scalekit and the external provider. **This ensures existing SSO connections continue to work while new connections use Scalekit.**
2. Gradually migrate existing SSO connections to Scalekit.

No reconfiguration of the identity provider is required as long as the **SSO proxy** handles authentication requests between Scalekit and the external SSO provider.

#### Scenario

Consider you have 20 SSO connections with an external SSO provider and customers have registered IdP configs in their identity providers (where the IdP posts user details after successful verification).

New SSO connections (the 21st and beyond) will use Scalekit as the SSO provider with configuration generated by Scalekit.

### Set up SSO proxy to co-exist with external SSO provider <Badge type="note" text="Phase 1"/>

![Diagram: SSO proxy coexisting with external provider](@/assets/docs/sso-migration-strategy/proxy-workos.png)


All existing organizations still authenticate through an external SSO provider. The SSO proxy ensures those connections continue to work while you gradually migrate. This approach is ideal when you prefer a staged rollout—move organizations one by one without forcing customers to reconfigure their IdP.

<Steps>
1. **Add a conditional between external provider and Scalekit authorization URL generation**

   Decide per organization (for example, by domain, organization ID, or connection ID) whether to initiate SSO with the external provider or Scalekit. This enables both systems to co-exist during migration.

   ```javascript title="auth-server.js"
   import express from "express";
   import { ExternalSSOProvider } from "external-sso-sdk";
   import { ScalekitClient } from "@scalekit-sdk/node";

   const app = express();

   const externalProviderOrganizationIds = ["org_test_idp", "org_01EHZNVPK3SFK441A1RGBFSHRT"]; // example selector

   const externalProvider = new ExternalSSOProvider(process.env.EXTERNAL_SSO_API_KEY);
   const scalekit = new ScalekitClient(
     process.env.SCALEKIT_ENVIRONMENT_URL,
     process.env.SCALEKIT_CLIENT_ID,
     process.env.SCALEKIT_CLIENT_SECRET
   );

   app.get("/auth", async (req, res) => {
     const organizationIdentifier = req.query.organization; // e.g. 'org_test_idp'
     let redirectUrl;

     if (externalProviderOrganizationIds.includes(organizationIdentifier)) {
       redirectUrl = externalProvider.sso.getAuthorizationUrl({
         organization: organizationIdentifier,
         clientId: process.env.EXTERNAL_SSO_CLIENT_ID,
         redirectUri: "https://yourapp.com/auth/ext-provider/callback",
         state: "external_provider",
       });
     } else {
       const portal = await scalekit.organization.generatePortalLink(
         "org_id_for_" + organizationIdentifier
       );
       redirectUrl = portal.location; // e.g., https://.../magicLink/...
     }

     res.redirect(redirectUrl);
   });

   app.listen(3000);
   ```

2. **Redirect users to your SSO proxy domain**

   After choosing the provider, send users to your SSO proxy (fronted by your **CNAME**, for example `auth.yourapp.com`). Ensure your proxy is deployed and reachable before testing.

   ```text title="Register both callback endpoints"
   https://yourapp.com/auth/ext-provider/callback
   https://yourapp.com/auth/scalekit/callback
   ```

3. **Proxy rewrites authorization to external SSO provider**

   The proxy forwards requests to the external provider, preserving identifiers such as **`state`** and **`organization`**.

   ```bash title="Example external provider authorize request"
   GET https://api.external-provider.com/sso/authorize?response_type=code \
     &client_id=sk_example_123456 \
     &redirect_uri=https://yourapp.com/callback/external-provider \
     &state=external_provider \
     &organization=org_01EHZNVPK3SFK441A1RGBFSHRT
   ```

4. **IdP authenticates and posts the response to your CNAME (proxy)**

   Your customers' IdP is configured with ACS/redirect URLs under your domain (CNAME), so successful SAML/OIDC responses return to the SSO proxy, not directly to your app.

   ```text title="ACS example"
   https://auth.yourapp.com/sso/saml/acs/{connection_id}
   ```

5. **Map the entity ID (callback ID)** so the proxy knows to use the external provider

   Provide the proxy with your existing **external provider callback identifiers** (often opaque IDs). The proxy uses these to route the SAML/OIDC callback to the external provider for processing. You can store these in environment variables or a JSON mapping file.

   ```text title="Example opaque callback path"
   https://auth.yourapp.com/ivETDqla2SfNIsvUH4mqqq6UL
   ```

6. **Receive the authorization code at your app's callback and exchange with the external provider**

   The external provider completes the handshake and redirects to your app's registered callback. The proxy can add a sentinel **state** (for example, **`external_provider`**) so your app knows to exchange the code with the external provider and fetch the user profile.

   ```javascript title="callback-handler.js (external provider)"
   import express from "express";
   import { ExternalSSOProvider } from "external-sso-sdk";

   const app = express();
   const externalProvider = new ExternalSSOProvider(process.env.EXTERNAL_SSO_API_KEY);

   app.get("/auth/ext-provider/callback", async (req, res) => {
     const { code, state, error, error_description } = req.query;
     if (error) return res.status(400).json({ error, error_description });

     try {
       const result = await externalProvider.sso.getProfileAndToken({
         code,
         clientId: process.env.EXTERNAL_SSO_CLIENT_ID,
         clientSecret: process.env.EXTERNAL_SSO_CLIENT_SECRET,
         redirectUri: "https://yourapp.com/auth/ext-provider/callback",
       });
       // result.profile contains user details; create session
       return res.redirect("/dashboard");
     } catch (e) {
       return res.status(500).json({ error: "External code exchange failed" });
     }
   });
   ```

7. **Create a session and finish login**

   Validate the tokens, establish the session, and redirect the user to the appropriate page in your application.

</Steps>


### Wrap up SSO proxy to handle SSO with Scalekit <Badge type="note" text="Phase 2"/>

![Diagram: SSO proxy routing callbacks to Scalekit](@/assets/docs/sso-migration-strategy/proxy-scalekit.png)

Once you create equivalent organizations in Scalekit for the ones you plan to migrate, the proxy can begin routing callbacks to Scalekit for those organizations while others continue on the external provider.

<Aside type="note">
  We're developing a migration utility that automatically detects your external SSO provider organizations and creates equivalent ones in Scalekit. This tool significantly reduces manual setup during migration. If you'd like early access to this utility, <a href="https://docs.scalekit.com/support/contact-us/">contact our support team</a>.
</Aside>

<Steps>
1. **Select provider per organization; route migrated organizations to Scalekit**

   Implement a provider selection check using your domain/organization/connection selector. For **organizations created in Scalekit**, choose the Scalekit branch and redirect the user to your **SSO proxy domain**.

2. **Scalekit manages the SSO connection and sends the user to the IdP**

   The customer's IdP configuration still points to your CNAME, so the successful SAML/OIDC response returns to the SSO proxy.

3. **Proxy rewrites the callback to Scalekit**

   The proxy uses the known legacy **callback ID** (from the earlier external provider) and issues a **307 redirect** to the Scalekit **Single Sign-On URL** for that organization in your Scalekit environment.

4. **Scalekit returns the authorization code to your Scalekit callback**

   Register a **separate callback URL** for Scalekit (recommended) so your app can clearly distinguish code exchanges from external provider vs. Scalekit flows.

5. **Identify the source and exchange the code with Scalekit**

   The proxy can set a sentinel **state** (for example, **`scalekit_p`**). When your app receives the code with this state, use **`scalekit.authenticateWithCode()`** or the **`/oauth/token`** endpoint to fetch ID and access tokens and the user's profile.

   ```javascript title="callback-handler.js (Scalekit)"
   import express from "express";
   import { ScalekitClient } from "@scalekit-sdk/node";

   const app = express();
   const scalekit = new ScalekitClient(
     process.env.SCALEKIT_ENVIRONMENT_URL,
     process.env.SCALEKIT_CLIENT_ID,
     process.env.SCALEKIT_CLIENT_SECRET
   );

   app.get("/auth/scalekit/callback", async (req, res) => {
     const { code, error, error_description } = req.query;
     if (error) return res.status(400).json({ error, error_description });

     try {
       const auth = await scalekit.authenticateWithCode(
         code,
         "https://yourapp.com/auth/scalekit/callback"
       );
       // auth.user contains user details; create session
       return res.redirect("/dashboard");
     } catch (e) {
       return res.status(500).json({ error: "Scalekit code exchange failed" });
     }
   });
   ```

6. **Complete login and session**

   Validate tokens, create the session, and proceed to your post-login route.

</Steps>


<Aside type="note">
  <p>
    Setting up an SSO proxy can be streamlined based on your infrastructure:
  </p>
  <ul>
    <li>Ready to deploy SSO proxy setup on AWS Lambda</li>
    <li>DNS configuration assistance with Cloudflare</li>
    <li>Custom infrastructure requirements</li>
  </ul>
  <p>
    For any technical assistance with your specific environment or infrastructure needs, please <a href="https://docs.scalekit.com/support/contact-us/">contact our team</a>. We're here to help ensure a smooth migration process.
  </p>
</Aside>
