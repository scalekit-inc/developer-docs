---
title: Federated Auth Integration Guide
description: Using Scalekit as a drop-in OAuth 2.1 authorization layer for your MCP Servers with federated authentication to your existing auth layer.
sidebar:
  label: 'Bring your own auth'
  order: 3
topic: 'mcp'
---
import Subtitle from '@/components/ui/Subtitle.astro'
import { CardGrid, Badge, Tabs, TabItem } from '@astrojs/starlight/components';

This document explains how to integrate your existing authentication system with Scalekit's drop-in OAuth 2.1 authorization layer. Follow the steps below to enable seamless and secure OAuth2.1 MCP layer for your users.

---

## Step-by-Step Workflow

When an MCP client initiates an authentication flow, Scalekit redirects to your login endpoint. You then provide user details to Scalekit via a secure backend call, and finally redirect back to Scalekit to complete the process.

![MCP Federated Auth - Sequence Diagram](@/assets/docs/m2m/mcp/mcp_federated_auth_sequence.png)

### 1. Initiate Authentication

- The MCP client starts the authentication flow by calling `/oauth/authorize` on Scalekit.
- Scalekit redirects the user to your login endpoint, passing two parameters:
  - `login_request_id`: Unique identifier for the login request.
  - `state`: Value to maintain state between requests.

**Example Redirect URL:**

```
https://app.example.com/login?login_request_id=lri_86659065219908156&state=HntJ_ENB6y161i9_P1yzuZVv2SSTfD3aZH-Tej0_Y33_Fk8Z3g
```

---

### 2. Handle Authentication in Your Application

Once the user lands on your login page:

#### a. Authenticate the User

Take the user through your regular authentication logic (e.g., username/password, SSO, etc.).

#### b. Send User Details to Scalekit

Send the authenticated userâ€™s profile details from your backend to Scalekit to complete the login handshake.

<Tabs group="sdk" style="pill">
<TabItem label="Python">

```bash
pip install scalekit-sdk
```

```python title="send_user_details.py"
from scalekit import ScalekitClient
import os

scalekit = ScalekitClient(
    os.environ.get('SCALEKIT_ENVIRONMENT_URL'),
    os.environ.get('SCALEKIT_CLIENT_ID'),
    os.environ.get('SCALEKIT_CLIENT_SECRET')
)

# Update login user details
scalekit.auth.update_login_user_details(
    connection_id="conn_98902496210059653",
    login_request_id="lri_98904304894738819",
    user={
        "sub": "1234567890",
        "email": "alice@example.com",
        "given_name": "Alice",
        "family_name": "Doe",
        "email_verified": True,
        "phone_number": "+1234567890",
        "phone_number_verified": False,
        "name": "Alice Doe",
        "preferred_username": "alice.d",
        "picture": "https://example.com/avatar.jpg",
        "gender": "female",
        "locale": "en-US",
        "groups": ["engineering", "devops", "admins"],
        "custom_attributes": {
            "department": "engineering",
            "security_clearance": "level2",
            "office_location": "Building A - Floor 3",
        },
    },
)
```

</TabItem>
<TabItem label="Node.js">

```bash
npm install @scalekit-sdk/node
```

```javascript title="sendUserDetails.js"
import { Scalekit } from '@scalekit-sdk/node';

// Initialize client
const scalekit = new Scalekit(
  process.env.SCALEKIT_ENVIRONMENT_URL,
  process.env.SCALEKIT_CLIENT_ID,
  process.env.SCALEKIT_CLIENT_SECRET
);

// Update login user details
await scalekit.auth.updateLoginUserDetails(
  'conn_98902496210059653',          // connectionId
  'lri_98914911014486405',           // loginRequestId
  {
    sub: '1234567890',
    email: 'alice@example.com',
    givenName: 'Alice',
    familyName: 'Doe',
    emailVerified: true,
    phoneNumber: '+1234567890',
    phoneNumberVerified: false,
    name: 'Alice Doe',
    preferredUsername: 'alice.d',
    picture: 'https://example.com/avatar.jpg',
    gender: 'female',
    locale: 'en-US',
    groups: ['engineering', 'devops', 'admins'],
    customAttributes: {
      department: 'engineering',
      security_clearance: 'level2',
      office_location: 'Building A - Floor 3',
    },
  }
);
```

</TabItem>
<TabItem label="cURL">

Aquire an `access_token` before you could send user details by hitting the `/oauth/token` endpoint. You can get `env_url`, `sk_client_id` and `sk_client_secret` from _Scalekit Dashboard > Settings_

```bash title="Terminal" frame="terminal"
curl --location '{{env_url}}/oauth/token' \
--header 'Content-Type: application/x-www-form-urlencoded' \
--data-urlencode 'grant_type=client_credentials' \
--data-urlencode 'client_id={{sk_client_id}}' \
--data-urlencode 'client_secret={{sk_client_secret}}'
```

Scalekit responds with a JSON payload similar to:
```json
{
  "access_token": "eyJhbGciOiJSUzI1NiIsInR5cCIgOiAiSldUIn0...",
  "token_type": "Bearer",
  "expires_in": 3600
}
```

Use the `access_token` in the `Authorization` header when making a machine-to-machine POST request to Scalekit with the user's details.

```bash
curl --location '{{env_url}}/api/v1/connections/{{connection_id}}/auth-requests/{{login_request_id}}/user' \
  --header 'Content-Type: application/json' \
  --header 'Authorization: Bearer {{access_token}}' \
  --data-raw '{
    "sub": "1234567890",
    "email": "alice@example.com",
    "given_name": "Alice",
    "family_name": "Doe",
    "email_verified": true,
    "phone_number": "+1234567890",
    "phone_number_verified": false,
    "name": "Alice Doe",
    "preferred_username": "alice.d",
    "picture": "https://example.com/avatar.jpg",
    "gender": "female",
    "locale": "en-US",
    "groups": [
      "engineering",
      "devops",
      "admins"
    ],
    "custom_attributes": {
      "department": "engineering",
      "security_clearance": "level2",
      "office_location": "Building A - Floor 3"
    }
  }'
```

</TabItem>
</Tabs>

:::note
- Replace placeholders like `{{env_url}}`, `{{connection_id}}`, `{{login_request_id}}`, and `{{access_token}}` with actual values.  
- Only `sub` and `email` are required fields; all other properties are optional.  
:::

---

### 3. Redirect Back to Scalekit

- Once you receive a successful response from Scalekit, redirect the user back to Scalekit using the provided `state` value to the below endpoint.

**Example Redirect URL:**

```
{{envurl}}/sso/v1/connections/{{connection_id}}/partner:callback?state={{state_value}}
```

`state_value` should match the `state` parameter you received in Step 1.

---

## 4. Completion

- After processing the callback from your auth system, Scalekit will handle the remaining steps (showing the consent screen to the user, token exchange, etc.) automatically.

:::tip

- Ensure your backend securely stores and transmits all sensitive data.
- The `login_request_id` and `state` parameters are essential for correlating requests and maintaining security.

:::

## Next Steps

**Download our sample MCP Server:** We have put together a simple MCP server that you can check out and run it locally to test the end to end functionality of a working MCP server complete with authentication and authorization. You can download and execute a sample MCP server implementation from <a href="https://github.com/scalekit-inc/mcp-auth-demos" target="_blank" rel="noopener">GitHub</a>.
