---
title: Authentication interceptors
description: Apply decision checks at key points in the authentication flow
head:
  - tag: style
    content: |
      .sl-markdown-content h2 {
        font-size: var(--sl-text-xl);
      }
      .sl-markdown-content h3 {
        font-size: var(--sl-text-lg);
      }
sidebar:
  badge:
    text: New
    variant: tip
---

import { Aside, Steps, TabItem, Tabs } from '@astrojs/starlight/components';

Authentication interceptors let you run custom validation at key points in the authentication flow. Use them to enforce security policies, apply business rules, or tailor the user experience during sign-up and login.

Scalekit exposes **trigger points** where you attach interceptors. For example, you can block sign-ups from suspicious IPs, restrict domains, or require approval for new registrations.

<br />

```d2 title="Pre-signup interceptor sequence"

shape: sequence_diagram

User -> Your app: Attempts sign-up
Your app -> Scalekit: Detects pre-signup trigger
Scalekit -> Your app: POST /auth/interceptors/pre-signup
Your app -> Scalekit: Decision ALLOW or DENY
Scalekit -> User: Proceed or block sign-up

```

| Trigger point | When it runs |
|----------------|-------------|
| Pre-signup | Before a user creates a new organization |
| Pre-session creation | Before session tokens are issued for a user |
| Pre-user invitation | Before sending an invitation to a user within an organization |
| Pre-M2M token creation | Before issuing a machine-to-machine access token |

#### Register an interceptor

In the Scalekit dashboard, register an interceptor at a trigger point from the **Interceptors** tab.

<details>
<summary> Interceptors page </summary>
![Interceptors settings in the Scalekit dashboard](@/assets/docs/auth-flow-interceptors/add-interceptor-page.png)
</details>

<br />

<Steps>


 1. Enter a descriptive name, choose a trigger point, and provide the HTTPS endpoint that will receive POST requests.
 2. Set the timeout for your service's response.
 3. Choose the fallback behavior if your service fails or times out (allow or block the flow).
 4. Click **Create**.
 5. Toggle **Enable** to activate the interceptor.

</Steps>

## Trigger points
{/*
#### `POST_USER_AUTHENTICATION`

<Tabs>
<TabItem label='Request body from Scalekit'>

```json title="POST_USER_AUTHENTICATION — request body" showLineNumbers=true collapse={9-14,24-31}
{
    "display_name": "Block suspicious IPs",
    "trigger_point": "POST_USER_AUTHENTICATION",
    "interceptor_context": {
        "environment_id": "env_12345",
        "user_id": "usr_9f8c7d6e5a",
        "user_email": "alice@example.com",
        "connection_details": [
            {
                "id": "conn_2f71c0",
                "type": "PASSWORDLESS",
                "provider": "SCALEKIT"
            }
        ],
        "user_agent": "Mozilla/5.0 (Macintosh; Intel Mac OS X) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36",
        "device_type": "desktop",
        "triggered_at": "2025-10-08T11:19:22.423Z"
    },
    "data": {
        "user": {
            "id": "usr_9f8c7d6e5a",
            "email": "alice@example.com",
            "email_verified": true,
            "memberships": [
                {
                    "organization_id": "org_a1b2c3",
                    "status": "ACTIVE"
                }
            ],
            "custom_attributes": {},
            "raw_attributes": {}
        }
    }
}
```

</TabItem>

<TabItem label='Response body from your service'>

```json title="POST_USER_AUTHENTICATION — response body" showLineNumbers=true
{
    "decision": "ALLOW | DENY",
    // When decision is DENY, include an error message.
    "error": {
        "message": "Sign-in blocked by policy"
    }
}
```

</TabItem>

</Tabs> */}



#### `PRE_SIGNUP`


<Tabs>
<TabItem label='Request body from Scalekit'>

```json title="PRE_SIGNUP — request body" showLineNumbers=true collapse={9-14,24-31}
{
    "display_name": "Block sign-ups from restricted IPs",
    "trigger_point": "PRE_SIGNUP",
    "interceptor_context": {
        "environment_id": "env_12345",
        "user_id": "usr_9f8c7d6e5a",
        "user_email": "alice@example.com",
        "connection_details": [
            {
                "id": "conn_2f71c0",
                "type": "PASSWORDLESS",
                "provider": "SCALEKIT"
            }
        ],
        "user_agent": "Mozilla/5.0 (Macintosh; Intel Mac OS X) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36",
        "device_type": "desktop",
        "triggered_at": "2025-10-08T11:13:15.972Z"
    },
    "data": {
        "user": {
            "id": "usr_9f8c7d6e5a",
            "email": "alice@example.com",
            "email_verified": true,
            "memberships": [
                {
                    "organization_id": "org_a1b2c3",
                    "status": "ACTIVE"
                }
            ],
            "custom_attributes": {},
            "raw_attributes": {}
        }
    }
}
```

</TabItem>

<TabItem label='Response body from your service'>

```json title="PRE_SIGNUP — response body" showLineNumbers=true
{
    "decision": "ALLOW | DENY",
    // When decision is DENY, include an error message.
    "error": {
        "message": "Sign-up blocked by policy"
    }
}
```

</TabItem>

</Tabs>

#### `PRE_SESSION_CREATE`

<Tabs>
<TabItem label='Request body from Scalekit'>

```json title="PRE_SESSION_CREATE — request body" showLineNumbers=true collapse={9-14,24-31}
{
    "display_name": "Block session issuance",
    "trigger_point": "PRE_SESSION_CREATE",
    "interceptor_context": {
        "environment_id": "env_12345",
        "user_id": "usr_9f8c7d6e5a",
        "user_email": "alice@example.com",
        "connection_details": [
            {
                "id": "conn_2f71c0",
                "type": "PASSWORDLESS",
                "provider": "SCALEKIT"
            }
        ],
        "user_agent": "Mozilla/5.0 (Macintosh; Intel Mac OS X) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36",
        "device_type": "desktop",
        "triggered_at": "2025-10-08T11:23:52.847Z"
    },
    "data": {
        "user": {
            "id": "usr_9f8c7d6e5a",
            "email": "alice@example.com",
            "email_verified": true,
            "memberships": [
                {
                    "organization_id": "org_a1b2c3",
                    "status": "ACTIVE"
                }
            ],
            "custom_attributes": {},
            "raw_attributes": {}
        }
    }
}

```
</TabItem>

</Tabs>

<Tabs>
<TabItem label='Response body (optional claims)'>

```json title="PRE_SESSION_CREATE — response body" showLineNumbers=true collapse={6-10}
{
    "decision": "ALLOW | DENY",
    // To modify token contents, include claims in the response.
    "response": {
        "claims": {
            "tier": "pro",
            "region": "eu-west-1"
        }
    },
    // When decision is DENY, include an error message.
    "error": {
        "message": "Session creation blocked by policy"
    }
}
```
</TabItem>

</Tabs>

<Aside type='note' title='Modify token claims in the response'>
 The `claims` field lets you include additional information in the issued tokens (access and ID tokens).
</Aside>

#### `PRE_USER_INVITE`

<Tabs>
<TabItem label='Request body from Scalekit'>

```json title="PRE_USER_INVITE — request body" showLineNumbers=true collapse={9-14,24-31}
{
    "display_name": "Block invitations from unverified domains",
    "trigger_point": "PRE_USER_INVITE",
    "interceptor_context": {
        "environment_id": "env_12345",
        "user_id": "usr_9f8c7d6e5a",
        "user_email": "alice@example.com",
        "connection_details": [
            {
                "id": "conn_2f71c0",
                "type": "PASSWORDLESS",
                "provider": "SCALEKIT"
            }
        ],
        "user_agent": "Mozilla/5.0 (Macintosh; Intel Mac OS X) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36",
        "device_type": "desktop",
        "triggered_at": "2025-10-08T11:29:53.667Z"
    },
    "data": {
        "user": {
            "id": "usr_9f8c7d6e5a",
            "email": "alice@example.com",
            "email_verified": true,
            "memberships": [
                {
                    "organization_id": "org_a1b2c3",
                    "status": "ACTIVE"
                }
            ],
            "custom_attributes": {},
            "raw_attributes": {}
        }
    }
}
```
</TabItem>


<TabItem label='Response body from your service'>

```json title="PRE_USER_INVITE — response body" showLineNumbers=true
{
    "decision": "ALLOW | DENY",
    // When decision is DENY, include an error message.
    "error": {
        "message": "Invitation blocked by policy"
    }
}
```
</TabItem>

</Tabs>

#### `PRE_M2M_TOKEN_CREATE`

<Tabs>
<TabItem label='Request body from Scalekit'>

```json title="PRE_M2M_TOKEN_CREATE — request body" showLineNumbers=true collapse={9-14,24-31}
{
    "display_name": "Block M2M token issuance",
    "trigger_point": "PRE_M2M_TOKEN_CREATE",
    "interceptor_context": {
        "environment_id": "env_12345",
        "user_id": "usr_9f8c7d6e5a",
        "user_email": "alice@example.com",
        "connection_details": [
            {
                "id": "conn_2f71c0",
                "type": "PASSWORDLESS",
                "provider": "SCALEKIT"
            }
        ],
        "user_agent": "Mozilla/5.0 (Macintosh; Intel Mac OS X) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36",
        "device_type": "desktop",
        "triggered_at": "2025-10-08T11:31:24.636Z"
    },
    "data": {
        "user": {
            "id": "usr_9f8c7d6e5a",
            "email": "alice@example.com",
            "email_verified": true,
            "memberships": [
                {
                    "organization_id": "org_a1b2c3",
                    "status": "ACTIVE"
                }
            ],
            "custom_attributes": {},
            "raw_attributes": {}
        }
    }
}

```
</TabItem>
<TabItem label='Response body (optional claims)'>

```json title="PRE_M2M_TOKEN_CREATE — response body" showLineNumbers=true collapse={6-10}
{
    "decision": "ALLOW | DENY",
    // To modify token contents, include claims in the response.
    "response": {
        "claims": {
            "scope": "read:reports write:jobs",
            "aud": "https://api.example.com"
        }
    },
    // When decision is DENY, include an error message.
    "error": {
        "message": "Token issuance blocked by policy"
    }
}
```
</TabItem>

</Tabs>

## Audit logs

Scalekit keeps a log of every interceptor request sent to your service and the response it returned. Use these logs to debug and troubleshoot issues.

Requests and responses generated by the "Test" button are not logged. This keeps production logs free of test data.
