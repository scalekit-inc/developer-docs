---
import { Badge } from '@astrojs/starlight/components'
import {
  IconLucideChevronDown,
  IconLucideUsers,
  IconMcp,
  IconMingcuteUserSecurityLine,
  IconAntDesignUserSwitchOutlined,
} from '@/utils/icon-map'

interface DropdownItem {
  label: string
  href: string
  icon: any
  badge?: string
}

interface DropdownSection {
  label: string
  items: DropdownItem[]
}

const sections: DropdownSection[] = [
  {
    label: '',
    items: [
      {
        label: 'Full stack Auth',
        href: '/authenticate/fsa/quickstart/',
        icon: IconLucideUsers,
      },
    ],
  },
  {
    label: 'Modular Auth',
    items: [
      {
        label: 'Auth for MCP',
        href: '/mcp/quickstart/',
        icon: IconMcp,
      },
      {
        label: 'Modular SSO',
        href: '/authenticate/sso/add-modular-sso/',
        icon: IconMingcuteUserSecurityLine,
      },
      {
        label: 'Modular SCIM',
        href: '/directory/scim/quickstart/',
        icon: IconAntDesignUserSwitchOutlined,
      },
    ],
  },
]

const pathname = Astro.url.pathname.replace(/\/+$/, '/')
const activeItem =
  sections.flatMap((section) => section.items).find((item) => pathname.startsWith(item.href)) ||
  sections[0].items[0]
---

<details class="authenticate-topics-dropdown">
  <summary class="dropdown-summary" aria-label="Choose authentication topic">
    <span class="dropdown-trigger">
      {
        (function () {
          const IconComponent = activeItem.icon
          return IconComponent && <IconComponent class="trigger-icon" />
        })()
      }
      <span class="trigger-label">{activeItem.label}</span>
      <IconLucideChevronDown class="chevron" aria-hidden="true" />
    </span>
  </summary>

  <div class="dropdown-panel">
    {
      sections.map((section) => (
        <section class="dropdown-section">
          {section.label.trim() !== '' && <p class="section-label">{section.label}</p>}
          <ul class="section-list">
            {section.items.map((item) => {
              const isActive = pathname.startsWith(item.href)
              return (
                <li>
                  <a class={`dropdown-link ${isActive ? 'is-active' : ''}`} href={item.href}>
                    {(function () {
                      const IconComponent = item.icon
                      return IconComponent && <IconComponent class="link-icon" />
                    })()}
                    <span class="link-title">{item.label}</span>
                    {item.badge && <Badge text={item.badge} variant="tip" />}
                  </a>
                </li>
              )
            })}
          </ul>
        </section>
      ))
    }
  </div>
</details>

<style>
  .authenticate-topics-dropdown {
    position: relative;
    border-radius: 0.375rem;
  }

  /* Override Nova theme's sidebar content gap within Starlight sidebar only */
  :global(#starlight__sidebar .sidebar-content) {
    gap: 0 !important;
  }

  .dropdown-summary {
    list-style: none;
    cursor: pointer;
  }

  /* Always apply blue styling to the dropdown trigger */
  .dropdown-summary .dropdown-trigger {
    display: flex;
    font-weight: 550;
    font-size: var(--sl-text-sm);
    border: 1px solid #e8e8e8;
    align-items: center;
    gap: 0.5rem;
    padding: 0.375rem 0.75rem;
    text-decoration: none;
    width: 100%;
    border-radius: 0.375rem;
    box-shadow: 0 1px 2px 0 rgba(10, 10, 10, 0.05);
  }

  .trigger-icon {
    width: 1rem;
    height: 1rem;
    flex-shrink: 0;
  }

  .dropdown-summary::-webkit-details-marker {
    display: none;
  }

  .trigger-label {
    text-align: left;
    font-size: inherit;
  }

  .chevron {
    margin-left: auto;
    width: 0.85rem;
    height: 0.85rem;
    opacity: 0.7;
    transition: transform 0.3s ease;
  }

  details[open] .chevron {
    transform: rotate(180deg);
  }

  .dropdown-panel {
    position: relative;
    margin-top: 0.25rem;
    border: 1px solid #e8e8e8;
    border-radius: 0.375rem;
    padding: 0.5rem 0;
    min-width: 16rem;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    background-color: var(--sl-color-bg);
    justify-content: center;
    align-items: center;
  }

  .dropdown-section + .dropdown-section {
    margin-top: 0.5rem;
  }

  .section-label {
    color: var(--sl-color-gray-3);
    padding: 0 1rem;
    font-size: 0.875rem;
    font-weight: 600;
  }

  .section-list {
    list-style: none;
    margin: 0;
    padding: 0;
    display: flex;
    flex-direction: column;
  }

  .dropdown-link {
    display: flex;
    align-items: center;
    padding: 0.5rem 1rem;
    text-decoration: none;
    color: var(--sl-color-gray-2);
    transition: color 0.2s ease;
    font-size: var(--sl-text-sm);
    gap: 0.5rem;
  }

  .link-icon {
    width: 1rem;
    height: 1rem;
    flex-shrink: 0;
  }

  .dropdown-link.is-active {
    font-weight: 600;
    color: var(--sl-color-white);
  }

  :root[data-theme='light'] .dropdown-link.is-active {
    color: var(--sl-color-gray-9);
  }

  .link-title {
    width: 100%;
  }

  @media (max-width: 50rem) {
    .dropdown-panel {
      border-radius: 0.5rem;
      min-width: auto;
      width: 100%;
    }
  }
</style>
