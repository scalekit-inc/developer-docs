---
import { LinkButton } from '@astrojs/starlight/components'
// @ts-ignore: icon-map is a local utility module without TS types
import { IconLucideChevronDown as IconChevronDown } from '../../utils/icon-map'

const loginHref = '/auth/login'
const dashboardHref = 'https://app.scalekit.com/'
---

<div class="auth-cta" data-auth-cta>
  <LinkButton
    href={loginHref}
    variant="primary"
    icon="right-arrow"
    iconPlacement="end"
    class="sk-primary"
  >
    Sign in
  </LinkButton>

  <div class="menu" data-auth-menu>
    <LinkButton
      href="#"
      variant="secondary"
      class="menu-trigger sk-secondary"
      data-auth-menu-trigger
      aria-haspopup="menu"
      aria-expanded="false"
    >
      Dashboard
      <IconChevronDown class="chevron" aria-hidden="true" />
    </LinkButton>
    <div class="menu-popover" data-auth-menu-popover role="menu">
      <a href="/auth/logout" role="menuitem">Sign out</a>
    </div>
  </div>
</div>

<script>
  // @ts-nocheck
  const STORAGE_KEY = 'sk_auth_session'

  const readCache = () => {
    try {
      const raw = localStorage.getItem(STORAGE_KEY)
      if (!raw) return null
      return JSON.parse(raw)
    } catch {
      return null
    }
  }

  /** @param {any} session */
  const writeCache = (session) => {
    try {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(session))
    } catch {}
  }

  const clearCache = () => {
    try {
      localStorage.removeItem(STORAGE_KEY)
    } catch {}
  }

  /** @param {any} expiresAt */
  const isExpired = (expiresAt) => {
    if (!expiresAt) return false
    return Date.now() >= expiresAt
  }

  const getSession = async () => {
    const cached = readCache()
    if (cached?.authenticated && !isExpired(cached.expiresAt)) {
      return cached
    }

    clearCache()

    try {
      const response = await fetch('/auth/session', { credentials: 'include' })
      if (!response.ok) {
        clearCache()
        return { authenticated: false }
      }

      const data = await response.json()
      if (data?.authenticated) {
        writeCache(data)
      } else {
        clearCache()
      }
      return data
    } catch {
      clearCache()
      return { authenticated: false }
    }
  }

  const ctas = document.querySelectorAll('[data-auth-cta]')

  /** @param {Element} cta */
  const updateCta = async (cta) => {
    const data = await getSession()
    if (data && data.authenticated) {
      cta.classList.add('is-authenticated')
    }

    const menu = cta.querySelector('[data-auth-menu]')
    if (!menu) return

    const trigger = menu.querySelector('[data-auth-menu-trigger]')
    const popover = menu.querySelector('[data-auth-menu-popover]')
    if (!trigger || !popover) return

    const closeMenu = () => {
      menu.classList.remove('is-open')
      trigger.setAttribute('aria-expanded', 'false')
    }

    const openMenu = () => {
      menu.classList.add('is-open')
      trigger.setAttribute('aria-expanded', 'true')
    }

    trigger.addEventListener('click', (event) => {
      event.preventDefault()
      event.stopPropagation()
      if (menu.classList.contains('is-open')) closeMenu()
      else openMenu()
    })

    document.addEventListener('click', (event) => {
      if (!menu.classList.contains('is-open')) return
      if (menu.contains(event.target)) return
      closeMenu()
    })

    document.addEventListener('keydown', (event) => {
      if (event.key !== 'Escape') return
      closeMenu()
    })
  }

  ctas.forEach(updateCta)
</script>

<style>
  .auth-cta :global(.sk-primary) {
    padding: 0.3rem 1.5rem;
    font-size: var(--sl-text-sm);
  }

  /* Logged-out: show Sign in only */
  .auth-cta > :global(a):nth-child(1) {
    display: inline-flex;
  }

  .auth-cta > .menu {
    display: none;
  }

  /* Logged-in: show dropdown only */
  .auth-cta.is-authenticated > :global(a):nth-child(1) {
    display: none;
  }

  .auth-cta.is-authenticated > .menu {
    display: inline-flex;
  }

  .menu {
    position: relative;
  }

  .menu-trigger {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
  }

  .chevron {
    font-size: 0.9em;
    opacity: 0.9;
  }

  .menu-popover {
    display: none;
    position: absolute;
    right: 0;
    top: calc(100% + 0.5rem);
    min-width: 12rem;
    background: var(--sl-color-bg);
    border: 1px solid var(--sl-color-gray-5);
    border-radius: 0.5rem;
    padding: 0.25rem;
    /* Similar feel to SecondaryNav dropdowns */
    box-shadow:
      0 1px 2px 0 rgba(10, 10, 10, 0.05),
      0 4px 6px -1px rgba(0, 0, 0, 0.1),
      0 10px 15px -3px rgba(0, 0, 0, 0.1);
    z-index: 50;
  }

  .menu.is-open .menu-popover {
    display: block;
  }

  .menu-popover a {
    display: block;
    padding: 0.5rem 0.75rem;
    border-radius: 0.375rem;
    text-decoration: none;
    color: var(--sl-color-text);
  }

  .menu-popover a:hover {
    background: var(--sl-color-gray-6);
  }
</style>
