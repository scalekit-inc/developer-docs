---
import { LinkButton } from '@astrojs/starlight/components'

const loginHref = '/auth/login'
const dashboardHref = 'https://app.scalekit.com/'
---

<div class="auth-cta" data-auth-cta>
  <LinkButton
    href={loginHref}
    variant="primary"
    icon="right-arrow"
    iconPlacement="end"
    class="sk-primary"
  >
    Sign in
  </LinkButton>
  <LinkButton
    href={dashboardHref}
    variant="primary"
    icon="right-arrow"
    iconPlacement="end"
    class="sk-primary"
  >
    Dashboard
  </LinkButton>
</div>

<script>
  const STORAGE_KEY = 'sk_auth_session'

  const readCache = () => {
    try {
      const raw = localStorage.getItem(STORAGE_KEY)
      if (!raw) return null
      return JSON.parse(raw)
    } catch {
      return null
    }
  }

  const writeCache = (session) => {
    try {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(session))
    } catch {}
  }

  const clearCache = () => {
    try {
      localStorage.removeItem(STORAGE_KEY)
    } catch {}
  }

  const isExpired = (expiresAt) => {
    if (!expiresAt) return false
    return Date.now() >= expiresAt
  }

  const getSession = async () => {
    const cached = readCache()
    if (cached?.authenticated && !isExpired(cached.expiresAt)) {
      return cached
    }

    clearCache()

    try {
      const response = await fetch('/auth/session', { credentials: 'include' })
      if (!response.ok) {
        clearCache()
        return { authenticated: false }
      }

      const data = await response.json()
      if (data?.authenticated) {
        writeCache(data)
      } else {
        clearCache()
      }
      return data
    } catch {
      clearCache()
      return { authenticated: false }
    }
  }

  const ctas = document.querySelectorAll('[data-auth-cta]')

  const updateCta = async (cta) => {
    const data = await getSession()
    if (data && data.authenticated) {
      cta.classList.add('is-authenticated')
    }
  }

  ctas.forEach(updateCta)
</script>

<style>
  .auth-cta :global(.sk-primary) {
    padding: 0.3rem 1.5rem;
    font-size: var(--sl-text-sm);
  }

  .auth-cta > :global(a):nth-child(2) {
    display: none;
  }

  .auth-cta.is-authenticated > :global(a):nth-child(1) {
    display: none;
  }

  .auth-cta.is-authenticated > :global(a):nth-child(2) {
    display: inline-flex;
  }
</style>
