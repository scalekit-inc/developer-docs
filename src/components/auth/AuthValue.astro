---
const { path = '' } = Astro.props
---

<span class="auth-value" data-auth-value={path}></span>

<script is:inline>
  const nodes = document.querySelectorAll('[data-auth-value]')

  const fetchSession = async () => {
    try {
      const response = await fetch('/auth/session', { credentials: 'include' })
      if (!response.ok) return null
      return await response.json()
    } catch {
      return null
    }
  }

  const resolvePath = (data, path) =>
    path.split('.').reduce((value, key) => (value ? value[key] : undefined), data)

  fetchSession().then((data) => {
    if (!data || !data.authenticated) return

    nodes.forEach((node) => {
      const path = node.getAttribute('data-auth-value') || ''
      const value = resolvePath(data, path)
      if (value !== undefined && value !== null) {
        node.textContent = String(value)
      }
    })
  })
</script>
