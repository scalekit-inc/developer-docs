---
import StarlightPage from '@astrojs/starlight/components/StarlightPage.astro'
import { getCollection } from 'astro:content'
import FoldCard from '@components/ui/FoldCard.astro'
import { Code } from '@astrojs/starlight/components'
import { LinkButton } from 'starlight-theme-nova/components'

// Load GitHub releases and get latest release data for each SDK
const releases = await getCollection('github-releases')

// Helper to get the absolute latest release for a repo
const getLatestRelease = (repoName: string) => {
  const repoReleases = releases
    .filter((release) => {
      const data = release.data as any
      return data.repoNameWithOwner === repoName
    })
    .map((release) => release.data as any)
    .sort((a, b) => {
      const dateA = a.publishedAt ? new Date(a.publishedAt).getTime() : 0
      const dateB = b.publishedAt ? new Date(b.publishedAt).getTime() : 0
      return dateB - dateA
    })

  return repoReleases.length > 0 ? repoReleases[0] : undefined
}

// Helper to format "2 weeks ago"
const formatTimeAgo = (dateString: string) => {
  if (!dateString) return ''
  const date = new Date(dateString)
  const now = new Date()
  const diffTime = Math.abs(now.getTime() - date.getTime())
  const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24))

  if (diffDays < 7) return `${diffDays} day${diffDays === 1 ? '' : 's'} ago`
  const weeks = Math.floor(diffDays / 7)
  if (diffDays < 30) return `${weeks} week${weeks === 1 ? '' : 's'} ago`
  const months = Math.floor(diffDays / 30)
  if (diffDays < 365) return `${months} month${months === 1 ? '' : 's'} ago`
  const years = Math.floor(diffDays / 365)
  return `${years} year${years === 1 ? '' : 's'} ago`
}

// Get latest release data for each SDK
const nodeRelease = getLatestRelease('scalekit-inc/scalekit-sdk-node')
const pythonRelease = getLatestRelease('scalekit-inc/scalekit-sdk-python')
const goRelease = getLatestRelease('scalekit-inc/scalekit-sdk-go')
const javaRelease = getLatestRelease('scalekit-inc/scalekit-sdk-java')

// Configuration Object for SDKs
const sdkConfig = {
  node: {
    title: 'Node.js',
    showTitle: false,
    icon: 'nodejs',
    href: '/sdks/node/',
    repo: 'scalekit-inc/scalekit-sdk-node',
    description: 'Full-featured, TypeScript-friendly SDK for modern Node.js based applications',
    features: ['TypeScript & ESM ready', 'Express, NestJS, Next.js compatible'],
    release: nodeRelease,
  },
  python: {
    title: 'Python',
    icon: 'python',
    href: '/sdks/python/',
    repo: 'scalekit-inc/scalekit-sdk-python',
    description: 'Async-first design with complete type hints and Pydantic validation',
    features: ['Pydantic v2 validated', 'FastAPI, Django, Flask compatible'],
    release: pythonRelease,
  },
  go: {
    title: 'Go',
    icon: 'go',
    href: '/sdks/go/',
    repo: 'scalekit-inc/scalekit-sdk-go',
    description: 'Zero-dependency, idiomatic Go SDK for high-performance services',
    features: ['Thread-safe & lightweight', 'Gin, Echo, Chi compatible'],
    release: goRelease,
  },
  java: {
    title: 'Java',
    icon: 'java',
    href: '/sdks/java/',
    repo: 'scalekit-inc/scalekit-sdk-java',
    description: 'Enterprise-ready SDK with seamless Spring Boot integration',
    features: ['Spring Boot integrated', 'Maven Central published'],
    release: javaRelease,
  },
}

const frontmatter = {
  title: 'Scalekit SDKs and APIs',
  template: 'splash' as const,
  description: 'Secure your  MCP servers, APIs, users - in one scalable stack',
  tableOfContents: false,
  hero: {
    tagline:
      'Add MCP auth, Agent Auth, or SSO as modular components - or adopt the full-stack platform for your B2B, AI application',
  },
  head: [
    {
      tag: 'style' as const,
      content: `
        right-sidebar-panel {
          display: none !important;
        }
        .hero {
          display: none !important;
        }
        .platform-divider {
          margin-top: 1rem !important;
        }
        .platform-features-grid {
          margin-top: 1rem !important;
        }
        .platform-features-grid .responsive-card-grid {
          margin-top: 1rem !important;
        }
        .platform-features-grid .responsive-card-grid article.fold-card {
          margin-top: 1rem !important;
        }
        .security-sections {
          display: grid;
          grid-template-columns: 1.2fr 1fr;
          gap: 1.5rem;
        }
        @media (max-width: 768px) {
          .security-sections {
            grid-template-columns: 1fr;
            gap: 1rem;
          }
        }
        .meta.sl-flex {
          display: none !important;
        }
        footer.sl-flex {
          display: none !important;
        }
        .fold-section {
          padding: 3rem 0;
          margin: 0;
        }
        .fold-section.fold--background-muted {
          background-color: #F8F9FF !important;
          background: #F8F9FF !important;
        }
        main .fold-section.fold--background-muted,
        .sl-markdown-content .fold-section.fold--background-muted,
        .content-panel .fold-section.fold--background-muted,
        body .fold-section.fold--background-muted {
          background-color: #F8F9FF !important;
          background: #F8F9FF !important;
        }
        .content-panel{
         padding-top: 0
        }
        .fold-full-width {
          width: 100vw;
          margin-left: 50%;
          transform: translateX(-50%);
          position: relative;
          z-index: 1;
        }
        main {
          overflow-x: hidden;
        }
        body {
          overflow-x: hidden;
        }
        .fold-container {
          max-width: 1280px;
          margin: 0 auto;
          padding: 0 4rem;
        }
        @media (max-width: 768px) {
          .fold-section {
            padding: 2rem 0;
          }
          .fold-container {
            padding: 0 1rem;
          }
        }
        .sdk-section-layout {
          display: flex;
          gap: 2rem;
          align-items: top;
        }
        .sdk-header-section {
          flex: 0 0 15.333%;
          display: flex;
          flex-direction: column;
          gap: 1rem;
        }
        .section-title {
          font-size: 1.375rem;
          margin: 0;
          font-weight: 600;
          color: var(--sl-color-text-heading);
        }
        .section-subtitle {
          font-size: 1.05rem;
          margin: 0;
          color: var(--sl-color-text-muted);
          line-height: 1.6;
        }
        .sdk-cards-grid {
          flex: 1;
          display: grid;
          grid-template-columns: repeat(2, 1fr);
          grid-template-rows: repeat(2, auto);
          gap: 1.5rem;
        }
        @media (max-width: 1024px) {
          .sdk-section-layout {
            flex-direction: column;
          }
          .sdk-header-section {
            flex: none;
            width: 100%;
          }
        }
        @media (max-width: 768px) {
          .sdk-cards-grid {
            grid-template-columns: 1fr;
          }
        }
        .api-section-layout {
          display: flex;
          gap: 2rem;
          align-items: top;
        }
        .api-header-section {
          flex: 0 0 15.333%;
          display: flex;
          flex-direction: column;
          gap: 1rem;
        }
        .section-title {
          font-size: 1.375rem;
          margin: 0;
          font-weight: 600;
          color: var(--sl-color-text-heading);
        }
        .section-description {
          font-size: 1.05rem;
          margin: 0;
          color: var(--sl-color-text-muted);
          line-height: 1.6;
        }
        .api-cards-grid {
          flex: 1;
          display: grid;
          grid-template-columns: repeat(2, 1fr);
          grid-template-rows: repeat(2, auto);
          gap: 1.5rem;
        }
        @media (max-width: 1024px) {
          .api-section-layout {
            flex-direction: column;
          }
          .api-header-section {
            flex: none;
            width: 100%;
          }
        }
        @media (max-width: 768px) {
          .api-cards-grid {
            grid-template-columns: 1fr;
          }
        }
        /* SDK Card Styles */
        .sdk-card-wrapper {
          display: flex;
          flex-direction: column;
          height: 100%;
        }
        .sdk-card-subtitle {
          font-size: 0.9rem;
          color: var(--sl-color-text-muted);
          line-height: 1.4;
          margin-bottom: 0.5rem;
          min-height: 2.8em; /* Align cards visually */
        }
        .sdk-card-features {
          margin: 0.5rem 0 1rem 0;
          font-size: 0.85rem;
        }
        .sdk-feature {
          display: flex;
          align-items: center;
          gap: 0.5rem;
          margin-bottom: 0.3rem;
          color: var(--sl-color-text);
        }
        .sdk-feature::before {
          content: "✓";
          color: var(--sl-color-accent);
        }
        .sdk-bottom-row {
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-top: auto;
          padding-top: 1rem;
          border-top: 1px solid var(--sl-color-hairline);
        }
        .sdk-meta-row {
          display: flex;
          align-items: center;
          gap: 1rem;
          font-size: 0.75rem;
          color: var(--sl-color-text-muted);
        }
        .meta-item {
          display: flex;
          align-items: center;
          gap: 0.3rem;
        }
        .status-dot {
          width: 8px;
          height: 8px;
          background-color: #10b981; /* Green */
          border-radius: 50%;
          display: inline-block;
        }
        .sdk-actions {
          display: flex;
          gap: 0.5rem;
        }
        .sl-markdown-content :not(a, strong, em, del, span, code, kbd, samp, var, pre, abbr, acronym, b, bdi, bdo, big, cite, dfn, i, mark, q, rp, rt, ruby, s, small, sub, sup, time, tt, u, wbr, img, video, audio, canvas, svg, iframe, embed, object, picture, source, track, map, area, input, button, select, textarea, label, output, progress, meter, details, summary, dialog, script, noscript, template, slot, content *) {
          margin-top: 0 !important;
        }
        .full-stack-auth-layout {
          display: flex;
          gap: 3rem;
          align-items: top;
          margin: 0;
        }
        .full-stack-auth-left {
          flex: 0 0 33.333%;
          display: flex;
          flex-direction: column;
          gap: 0.5rem;
        }
        .full-stack-auth-heading {
          font-size: 1.4rem;
          margin: 0;
          font-weight: 600;
          color: var(--sl-color-text-heading);
        }
        .full-stack-auth-description {
          font-size: 1.1rem;
          margin: 0;
          color: var(--sl-color-text-muted);
          line-height: 1.6;
        }
        .full-stack-auth-card {
          flex: 1;
        }
        @media (max-width: 1024px) {
          .full-stack-auth-layout {
            flex-direction: column;
          }
          .full-stack-auth-left {
            flex: none;
            width: 100%;
          }
        }
        button[aria-label="Menu"].sl-flex.md\\:sl-hidden {
          display: none !important;
        }
      `,
    },
  ],
  prev: false,
  next: false,
}
---

<StarlightPage frontmatter={frontmatter} hasSidebar={false}>
  <div class="fold-section fold-full-width">
    <div class="fold-container">
      <div class="sdk-section-layout">
        <div class="sdk-header-section">
          <h1
            class="section-title"
            style="margin-top: 1.8rem !important; font-size: 1.9rem !important;"
          >
            SDKs
          </h1>
          <div class="section-subtitle"></div>
        </div>
        <div class="sdk-cards-grid">
          {
            Object.values(sdkConfig).map((sdk) => (
              <div class="sdk-card-wrapper">
                <FoldCard
                  title={sdk.title}
                  iconKey={sdk.icon}
                  href={sdk.href}
                  badge={sdk.release ? { text: sdk.release.tagName } : undefined}
                  showCta={false}
                  showTitle={false}
                  clickable={false}
                  ctaSmall={true}
                >
                  <div class="sdk-card-subtitle">{sdk.description}</div>

                  <div class="sdk-card-features">
                    {sdk.features.map((feature) => (
                      <div class="sdk-feature">{feature}</div>
                    ))}
                  </div>

                  <div class="sdk-bottom-row">
                    <div class="sdk-meta-row">
                      {sdk.release && (
                        <>
                          <div class="meta-item" title="Actively Maintained">
                            <span class="status-dot" />
                            Updated {formatTimeAgo(sdk.release.publishedAt)}
                          </div>

                          {/* Pulling stars directly from loader data */}
                          {sdk.release.repoStargazerCount > 50 && (
                            <div class="meta-item" title="GitHub Stars">
                              ⭐ {sdk.release.repoStargazerCount}
                            </div>
                          )}
                        </>
                      )}
                    </div>

                    <div class="sdk-actions">
                      <LinkButton
                        href={sdk.href}
                        variant="secondary"
                        icon="right-arrow"
                        iconPlacement="end"
                        class="sk-secondary"
                      >
                        Get Started
                      </LinkButton>
                    </div>
                  </div>
                </FoldCard>
              </div>
            ))
          }
        </div>
      </div>
    </div>
  </div>

  <div class="fold-section fold--background-muted fold-full-width">
    <div class="fold-container">
      <div class="api-section-layout">
        <div class="api-header-section">
          <h1
            class="section-title"
            style="margin-top: 1.8rem !important; font-size: 1.9rem !important;"
          >
            APIs
          </h1>
          <div class="section-description"></div>
        </div>
        <div class="api-cards-grid">
          <FoldCard
            title="REST APIs"
            iconKey="api"
            href="/apis/"
            showCta={false}
            showTitle={true}
            clickable={false}
            ctaSmall={true}
          >
            <div class="sdk-card-subtitle">
              Programmatic control to manage users, orgs, sessions, and more
            </div>

            <div class="sdk-bottom-row">
              <div class="sdk-meta-row">
                <!-- Empty for now -->
              </div>

              <div class="sdk-actions">
                <LinkButton
                  href="/apis/#description/quickstart"
                  variant="secondary"
                  icon="right-arrow"
                  iconPlacement="end"
                  class="sk-secondary"
                >
                  Get Started
                </LinkButton>
              </div>
            </div>
          </FoldCard>

          <FoldCard
            title="Webhooks"
            iconKey="webhooks"
            href="/apis/#webhook/organizationcreated"
            showCta={false}
            showTitle={true}
            clickable={false}
            ctaSmall={true}
          >
            <div class="sdk-card-subtitle">
              Receive real-time events for authentication, user lifecycle, and organizations
            </div>

            <div class="sdk-bottom-row">
              <div class="sdk-meta-row">
                <a href="/authenticate/implement-workflows/implement-webhooks" class="action-link">
                  See docs
                </a>
              </div>

              <div class="sdk-actions">
                <LinkButton
                  href="/apis/#webhook/organizationcreated"
                  variant="secondary"
                  icon="right-arrow"
                  iconPlacement="end"
                  class="sk-secondary"
                >
                  View events
                </LinkButton>
              </div>
            </div>
          </FoldCard>

          <FoldCard
            title="Interceptors"
            iconKey="workflow"
            href="/reference/interceptors/triggers"
            showCta={false}
            showTitle={true}
            clickable={false}
            ctaSmall={true}
          >
            <div class="sdk-card-subtitle">
              Apply custom logic and policy checks during authentication & authorization flows
            </div>

            <div class="sdk-bottom-row">
              <div class="sdk-meta-row">
                <a href="/authenticate/interceptors/auth-flow-interceptors" class="action-link">
                  See docs
                </a>
              </div>

              <div class="sdk-actions">
                <LinkButton
                  href="/reference/interceptors/triggers"
                  variant="secondary"
                  icon="right-arrow"
                  iconPlacement="end"
                  class="sk-secondary"
                >
                  View triggers
                </LinkButton>
              </div>
            </div>
          </FoldCard>
        </div>
      </div>
    </div>
  </div>
</StarlightPage>

<script>
  // Prevent card click when clicking on footer links
  document.querySelectorAll('.action-link').forEach((link) => {
    link.addEventListener('click', (e) => {
      e.stopPropagation()
    })
  })
</script>
